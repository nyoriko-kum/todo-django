trigger:
  branches:
    include:
      - main

pool:
  name: 'nameagent-pool'

variables:
  # ACR
  acrName: 'test'                      # ← あなたのACR名
  acrLoginServer: 'test.azurecr.io'    # ← 上と合わせる
  imageTag: '$(Build.BuildId)'

  # Azureリソース
  resourceGroup: 'test-CICD'               # ← あなたのRG
  vmssName: 'test-vmss'                    # ← デプロイしたいVMSS名

steps:
  # ① ソース取得
  - checkout: self

  # ② ACRにログイン
  - task: Docker@2
    displayName: 'Login to ACR'
    inputs:
      command: login
      containerRegistry: 'MyDockerConnection'

  # ③ docker-compose で一括ビルド & push
  - script: |
      echo "=== Building & pushing images via docker-compose ==="

      # docker-compose.yml の中で image: に ACR パスが設定されている前提
      docker compose build
      docker compose push
    displayName: 'Build & Push with Docker Compose'

  # ③ VMSS の中で docker compose を叩かせる
  #    → VMSS の各VMに「最新イメージをpullして起動し直して」と言う
  #    ここが“Managed Imageつくる” の代わりになるところ
  - task: AzureCLI@2
    displayName: 'Update VMSS instances (pull & restart containers)'
    inputs:
      azureSubscription: 'MyServiceConnection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # VMSS 内で実行させたいシェルをここに書く
        # 今回は「ACRログイン→最新の3コンテナpull→docker compose up -d」みたいなことを想定
        # ポイント：これは"VMSSの各インスタンス"で動きます

        # 1) ACRのパスワードなどを取得（Managed IdentityでやるならここをMI用に変える）
        ACR_LOGIN_SERVER=$(echo $(acrName) | sed 's/$/.azurecr.io/')
        echo "ACR: $ACR_LOGIN_SERVER"

        # 2) VMSSの全インスタンスに対してスクリプトを実行
        #    ※ このコマンドは各VMで /bin/bash が実行されます
        az vmss run-command invoke \
          --resource-group $(resourceGroup) \
          --name $(vmssName) \
          --command-id RunShellScript \
          --scripts "
          　echo '=== Updating containers on VMSS ==='
            az acr login --name $(acrName)
            cd /opt/app
            docker compose pull
            docker compose down
            docker compose up -d
          "


